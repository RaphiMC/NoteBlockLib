# NoteBlockLib
Library for reading, writing, manipulating and playing note block songs.

To use NoteBlockLib in your application, check out the [Usage](#usage) section.

## Features
- Reads .nbs, .mid, .txt and .notebot files
- Can write/create .nbs and .txt files
- Offers an easy way to play note block songs in your application
- Pretty good MIDI converter
- Supports all NBS versions (even with undocumented features)
- Many utils for manipulating songs
  - Optimize songs for use in Minecraft (Transposing, Resampling, Converting)
  - Resampling songs with a different TPS

## Releases
### Gradle/Maven
To use NoteBlockLib with Gradle/Maven you can use this [Maven server](https://maven.lenni0451.net/#/releases/net/raphimc/NoteBlockLib) or [Jitpack](https://jitpack.io/#RaphiMC/NoteBlockLib).  
You can also find instructions how to implement it into your build script there.

## Usage
### Concepts and terminology
The main class of NoteBlockLib is the ``NoteBlockLib`` class. It contains all the methods for reading, writing and creating songs.  
The utils for manipulating songs are located in the ``util`` package.

#### Song
Song is a wrapper class around the Header, Data and the View of a song.  
The Header and Data classes are the low level representation of a song. They are used by I/O operations.  
The View class is a high level representation of a song and is generated from the Header and Data classes.

#### Header
The header usually contains the metadata of a song. This includes the author, the original author, the description, the tempo, the delay and the length of the song.

#### Data
The data contains all the notes of a song. This includes the tick at which the note should be played, the instrument and the key.

#### SongView
The SongView is a high level and generalized representation of a song. It contains only the most important information of a song.  
The view is used for most operations like playing a song or manipulating it. Due to the fact that the view is a high level representation of a song, it is not suitable for I/O operations directly.  
To create a low level representation (Song) from the view again you can use the ``NoteBlockLib.createSong(view, format)`` method.
The returned song only has the bare minimum of data required to be written to a file. You can use the setter methods of the Header and Data class to add more data to the song.  
The view is generated by default only once when the Song class is created. If you want to refresh the view you can use the ``Song.refreshView()`` method.

### Reading a song
To read a song you can use the ``NoteBlockLib.readSong(<input>, [format])`` method.
The input can be a File, InputStream or a byte array.
The format is optional and can be used to specify the format of the input. If the format is not specified, NoteBlockLib will try to guess the format based on the file extension.

### Writing a song
To write a song you can use the ``NoteBlockLib.writeSong(<song>, <output>)`` method.

### Creating a song
The easiest way to create a song is to create a SongView and then use the ``NoteBlockLib.createSongFromView(<view>, [format])`` method to create a Song from it.  
Alternatively you can create a Song directly by using the ``new Song(null, <header>, <data>)`` constructor. This requires you to create the Header and Data yourself.

### Playing a song
To play a song you can use the ``SongPlayer`` class. The SongPlayer provides basic controls like play, pause, stop and seek.  
To instantiate it you can use the ``new SongPlayer(<songView>, <callback>)`` constructor.  
The callback contains basic methods like ``onFinished`` and ``playNote`` to handle the playback of the song.

### Manipulating a song
There are multiple utils for manipulating a song.

#### SongResampler
The SongResampler can be used to resample a song to a different TPS without changing the musical speed or length of the song.  
This is very useful if you want to export the song as a schematic and play it in Minecraft as that is limited to 10 TPS.

#### MinecraftDefinitions
The MinecraftDefinitions class contains definitions and formulas for Minecraft related manipulations.  
This includes multiple methods for getting notes within the Minecraft octave range, converting between Minecraft and NBS id systems and more.

#### SongUtil
This class has some general utils for manipulating songs like applying a modification to all notes of a song.

## Examples
**Reading a song, transposing its notes and writing it back**
```java
Song<?, ?, ?> song = NoteBlockLib.readSong(new File("input.nbs"));

// Clamp the note key
// SongUtil.applyToAllNotes(song.getView(), MinecraftDefinitions::clampNoteKey);

// Transpose the note key
SongUtil.applyToAllNotes(song.getView(), MinecraftDefinitions::transposeNoteKey);

// Shift the instrument of out of range notes to a higher/lower one. Sounds better than above.
// SongUtil.applyToAllNotes(song.getView(), MinecraftDefinitions::instrumentShiftNote);
// Clamp the remaining out of range notes
// SongUtil.applyToAllNotes(song.getView(), MinecraftDefinitions::clampNoteKey);
        
NoteBlockLib.writeSong(song, new File("output.nbs"));
```
**Reading a MIDI, and writing it as NBS**
```java
Song<?, ?, ?> midiSong = NoteBlockLib.readSong(new File("input.mid"));
Song<?, ?, ?> nbsSong = NoteBlockLib.createSongFromView(midiSong.getView(), SongFormat.NBS);
NoteBlockLib.writeSong(nbsSong, new File("output.nbs"));
```
**Reading a song, changing its sample rate to 10 TPS and writing it back**
```java
Song<?, ?, ?> song = NoteBlockLib.readSong(new File("input.nbs"));

SongResampler.changeTickSpeed(song.getView(), 10F);

Song<?, ?, ?> newSong = NoteBlockLib.createSongFromView(song.getView(), SongFormat.NBS);
// For songs with custom instruments make sure to copy them over to the new song
// ((NbsSong)newSong).getData().setCustomInstruments(((NbsSong)song).getData().getCustomInstruments());

NoteBlockLib.writeSong(newSong, new File("output.nbs"));
```
**Creating a new song and saving it as NBS**
```java
// tick -> list of notes
Map<Integer, List<Note>> notes = new TreeMap<>();
// Add the notes to the song
notes.put(0, Lists.newArrayList(new NbsNote(Instrument.HARP.nbsId(), (byte) 46)));
notes.put(5, Lists.newArrayList(new NbsNote(Instrument.BASS.nbsId(), (byte) 60)));
notes.put(8, Lists.newArrayList(new NbsNote(Instrument.BIT.nbsId(), (byte) 84)));
SongView<Note> mySong = new SongView<>("My song" /*title*/, 10F /*ticks per second*/, notes);

Song<?, ?, ?> nbsSong = NoteBlockLib.createSongFromView(mySong, SongFormat.NBS);

NoteBlockLib.writeSong(nbsSong, new File("C:\\Users\\Koppe\\Desktop\\output.nbs"));
```

## Contact
If you encounter any issues, please report them on the
[issue tracker](https://github.com/RaphiMC/NoteBlockLib/issues).  
If you just want to talk or need help implementing NoteBlockLib feel free to join my
[Discord](https://discord.gg/dCzT9XHEWu).
